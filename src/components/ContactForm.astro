---
//proyect id para saber que proyecto consulta el usuario
const { initialSubject, projectId } = Astro.props; 
//si no se le manda nada al form el titulo por defecto es consulta de proyecto
const subjectValue = initialSubject || "Consulta de proyecto";
---

<section class="bg-white rounded-xl text-gray-800 text-left w-full max-w-2xl mx-auto">
    <h2 class="text-2xl md:text-3xl font-bold text-center text-gray-900" id="modal-title">
        Hablemos de tu proyecto o consulta
    </h2>
    <p class="text-center text-gray-500 mb-6 mt-2 text-sm md:text-base">
        Envíame un mensaje, ¡tu consulta no es molestia!
    </p>
    
    <form id="contact-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4 md:gap-6">
        
        <input type="hidden" name="_project_id" value={projectId} />

        <div class="sm:col-span-1">
            <label for="name" class="block text-sm font-semibold text-gray-700 mb-1">Nombre completo:</label>
            <input 
                type="text" 
                id="name" 
                name="name" 
                required 
                class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 outline-none transition-all duration-200 bg-gray-50 focus:bg-white"
                placeholder="Tu nombre"
            >
        </div>

        <div class="sm:col-span-1">
            <label for="email" class="block text-sm font-semibold text-gray-700 mb-1">Correo electrónico:</label>
            <input 
                type="email" 
                id="email" 
                name="email" 
                required 
                class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 outline-none transition-all duration-200 bg-gray-50 focus:bg-white"
                placeholder="tu@email.com"
            >
        </div>

        <div class="sm:col-span-2">
            <label for="subject" class="block text-sm font-semibold text-gray-700 mb-1">Asunto:</label>
            <input 
                type="text" 
                id="subject" 
                name="subject" 
                required 
                value={subjectValue}
                class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 outline-none transition-all duration-200 bg-gray-50 focus:bg-white"
            >
        </div>

        <div class="sm:col-span-2">
            <label for="message" class="block text-sm font-semibold text-gray-700 mb-1">Mensaje:</label>
            <textarea 
                id="message" 
                name="message" 
                rows="4" 
                required 
                class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 outline-none transition-all duration-200 bg-gray-50 focus:bg-white resize-none"
                placeholder="Contame sobre tu idea o duda..."
            ></textarea>
        </div>

        <div class="sm:col-span-2 mt-2">
            <button 
                type="submit" 
                id="submit-button" 
                class="w-full py-3.5 px-6 bg-pink-500 text-white font-bold rounded-lg hover:bg-pink-600 active:scale-[0.98] transition-all duration-200 shadow-md hover:shadow-lg"
            >
                Enviar mail
            </button>
            
            <p id="form-status" aria-live="polite" class="mt-4 text-center text-sm font-medium"></p>
        </div>

    </form>
</section>

<script>
    //direccion de la api que recibe los datos y los envia al mail
    const FORMSPREE_ENDPOINT = 'https://formspree.io/f/xjknpawo'; 

    const form = document.getElementById('contact-form') as HTMLFormElement | null;
    const status = document.getElementById('form-status') as HTMLParagraphElement | null;
    const button = document.getElementById('submit-button') as HTMLButtonElement | null;

//existe el form, el status y el button?
    if (form && status && button) {
        //escuchar el evento submit
        form.addEventListener('submit', async (event) => {
            //evitar recarga de pagina
            event.preventDefault(); 
//deshabilitar el boton para evitar multiples envios
            button.disabled = true;
            const originalText = button.innerText;
            button.innerText = 'Enviando...';
            status.textContent = '';
            
            //crear un objeto FormData con los datos del form
            const data = new FormData(form);
            
            try {
                const response = await fetch(FORMSPREE_ENDPOINT, {
                    method: 'POST',
                    body: data, 
                    // indicar que esperamos json de respuesta
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (response.ok) {
                    status.textContent = '¡Mensaje enviado con éxito! Te responderé pronto.';
                    status.className = 'mt-3 text-center text-sm font-bold text-green-600 animate-pulse';
                    form.reset(); 
                    button.innerText = '¡Enviado!';
                    
                    // CERRAR MODAL
                    const modal = document.getElementById('contact-modal');
                    setTimeout(() => {
                        if (modal) {
                            modal.classList.remove('is-open');
                            document.body.style.overflow = ''; 
                            // restaurar boton despues de cerrar
                            button.disabled = false;
                            button.innerText = originalText;
                            status.textContent = '';
                        }
                    }, 2000);
                } else {
                    status.textContent = `Hubo un error. Intenta nuevamente.`;
                    status.className = 'mt-3 text-center text-sm font-bold text-red-600';
                    button.disabled = false;
                    button.innerText = originalText;
                }
            } catch (error) {
                status.textContent = 'Error de conexión. Verifica tu internet.';
                status.className = 'mt-3 text-center text-sm font-bold text-red-600';
                button.disabled = false;
                button.innerText = originalText;
            }
        });
    }
</script>